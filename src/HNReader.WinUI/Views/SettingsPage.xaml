<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="HNReader.WinUI.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:HNReader.Core.Models"
    xmlns:converters="using:HNReader.WinUI.Converters"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    </Page.Resources>

    <Grid Padding="32,24,32,24">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="28" MaxWidth="800" HorizontalAlignment="Left">
                
                <!-- Page Header -->
                <StackPanel Spacing="4">
                    <TextBlock Text="Settings" Style="{StaticResource TitleTextBlockStyle}" FontWeight="Bold" />
                    <TextBlock Text="Customize your HN Reader experience"
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                </StackPanel>

                <!-- AI Vault Section -->
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE8B7;" FontSize="20" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                        <TextBlock Text="Copilot Knowledge Vault" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>
                    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            CornerRadius="8"
                            Padding="20">
                        <StackPanel Spacing="12">
                            <StackPanel Spacing="4">
                                <TextBlock Text="Your Vault" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                <TextBlock Text="Select a folder to use as your AI knowledge base for Copilot CLI."
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                           TextWrapping="Wrap" />
                            </StackPanel>

                            <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="16">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" 
                                            Background="{ThemeResource AccentFillColorDefaultBrush}" 
                                            CornerRadius="6" 
                                            Padding="10"
                                            Margin="0,0,12,0">
                                        <FontIcon Glyph="&#xE8B7;" FontSize="20" Foreground="White" />
                                    </Border>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                                        <TextBlock Text="{Binding VaultDisplayName, Mode=OneWay}" 
                                                   FontWeight="SemiBold"
                                                   Style="{StaticResource BodyTextBlockStyle}" />
                                        <TextBlock Text="{Binding VaultPath, Mode=OneWay}" 
                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                   TextTrimming="CharacterEllipsis"
                                                   Visibility="{Binding HasVault, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}" />
                                    </StackPanel>

                                    <StackPanel Margin="2,0,0,0" Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                        <Button x:Name="SelectVaultButton"
                                                Click="SelectVaultButton_Click"
                                                Style="{StaticResource AccentButtonStyle}">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <FontIcon Glyph="&#xE838;" FontSize="14" />
                                                <TextBlock Text="Browse" />
                                            </StackPanel>
                                        </Button>
                                        <Button x:Name="ClearVaultButton"
                                                Command="{Binding ClearVaultCommand}"
                                                Visibility="{Binding HasVault, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                                ToolTipService.ToolTip="Remove vault">
                                            <FontIcon Glyph="&#xE74D;" FontSize="14" />
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>

                            <StackPanel Spacing="8">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Model" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                    <TextBlock Text="Choose the model used for digest generation and story insights."
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                               TextWrapping="Wrap" />
                                </StackPanel>
                                <ComboBox SelectedIndex="{Binding SelectedCopilotModelIndex, Mode=TwoWay}"
                                          ItemsSource="{Binding CopilotModelOptions}"
                                          MinWidth="200" />
                            </StackPanel>

                            <!-- Knowledge Vault Info -->
                            <InfoBar
                                IsOpen="True"
                                IsClosable="False"
                                Severity="Informational"
                                Title="About Knowledge Vault">
                                <InfoBar.Content>
                                    <StackPanel Spacing="8">
                                        <TextBlock TextWrapping="Wrap" Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                            Copilot CLI will have read/write access to files in your vault folder. Story markdown files and news digests are saved here for Copilot to analyze.
                                        </TextBlock>
                                        <HyperlinkButton 
                                            Content="Learn more about Copilot CLI modes" 
                                            NavigateUri="https://docs.github.com/en/copilot/concepts/agents/about-copilot-cli#modes-of-use" />
                                    </StackPanel>
                                </InfoBar.Content>
                            </InfoBar>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- News Digest Interests -->
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE728;" FontSize="20" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                        <TextBlock Text="News Digest Interests" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>
                    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            CornerRadius="8"
                            Padding="20">
                        <StackPanel Spacing="12">

                            <!-- Digest Stories Per Interest -->
                            <StackPanel Spacing="8">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Digest Stories Per Interest" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                    <TextBlock Text="Maximum stories per interest group in news digest" 
                                               Style="{StaticResource CaptionTextBlockStyle}" 
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                </StackPanel>
                                <ComboBox SelectedIndex="{Binding MaxStoriesPerDigestGroupIndex, Mode=TwoWay}" 
                                          ItemsSource="{Binding MaxStoriesPerDigestGroupOptions}"
                                          MinWidth="120" />
                            </StackPanel>
                            <StackPanel Spacing="4">
                                <TextBlock Text="Your Interests" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                <TextBlock Text="Topics to personalize your news digest (max 5)"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            </StackPanel>

                            <Grid ColumnSpacing="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="150" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <TextBox Grid.Column="0" Grid.Row="0"
                                         PlaceholderText="Interest"
                                         Text="{Binding NewInterestName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         MaxLength="30" />

                                <TextBox Grid.Column="1" Grid.Row="0"
                                         PlaceholderText="Description"
                                         Text="{Binding NewInterestDescription, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         MaxLength="100" />

                                <Button Grid.Column="2" Grid.Row="0"
                                        x:Name="AddInterestButton"
                                        Command="{Binding AddInterestCommand}"
                                        IsEnabled="{Binding CanAddInterest, Mode=OneWay}"
                                        Style="{StaticResource AccentButtonStyle}"
                                        Width="44" Height="32">
                                    <FontIcon Glyph="&#xE710;" FontSize="16" />
                                </Button>

                                <!-- Character counters -->
                                <TextBlock Grid.Column="0" Grid.Row="1"
                                           Text="{Binding InterestNameCharactersRemaining, Mode=OneWay}"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                           HorizontalAlignment="Right"
                                           Margin="0,4,0,0" />

                                <TextBlock Grid.Column="1" Grid.Row="1"
                                           Text="{Binding InterestDescriptionCharactersRemaining, Mode=OneWay}"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                           HorizontalAlignment="Right"
                                           Margin="0,4,0,0" />
                            </Grid>

                            <ItemsControl x:Name="InterestsItemsControl" ItemsSource="{Binding UserInterests, Mode=OneWay}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                BorderThickness="1" CornerRadius="4" Padding="12" Margin="0,0,0,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0" Spacing="4">
                                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                                    <TextBlock Text="{Binding Description}" 
                                                               Style="{StaticResource CaptionTextBlockStyle}"
                                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                               Visibility="{Binding Description, Converter={StaticResource BoolToVisibilityConverter}}" />
                                                </StackPanel>
                                                <Button Grid.Column="1" 
                                                        Command="{Binding ElementName=InterestsItemsControl, Path=DataContext.RemoveInterestCommand}"
                                                        CommandParameter="{Binding}"
                                                        Background="Transparent" 
                                                        BorderThickness="0" 
                                                        VerticalAlignment="Center">
                                                    <FontIcon Glyph="&#xE74D;" FontSize="14" />
                                                </Button>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <Border x:Name="EmptyStateBorder"
                                    Background="{ThemeResource LayerFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1" CornerRadius="4" Padding="24,16"
                                    Visibility="{Binding HasNoInterests, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="No interests added yet. Add your first interest above!"
                                           Style="{StaticResource CaptionTextBlockStyle}"
                                           Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                           HorizontalAlignment="Center" />
                            </Border>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Theme -->
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE790;" FontSize="20" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                        <TextBlock Text="Appearance" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>
                    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="20">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <StackPanel Spacing="4">
                                <TextBlock Text="Theme" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                <TextBlock Text="Select your preferred app theme" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            </StackPanel>
                            <ComboBox Grid.Column="1" MinWidth="180" SelectedIndex="{Binding SelectedThemeIndex, Mode=TwoWay}" ItemsSource="{Binding ThemeOptions}" />
                        </Grid>
                    </Border>
                </StackPanel>

                <!-- Performance -->
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE916;" FontSize="20" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                        <TextBlock Text="Performance" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>
                    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="20">
                        <StackPanel Spacing="12">
                            <StackPanel Spacing="4">
                                <TextBlock Text="Stories to Fetch" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                <TextBlock Text="Maximum stories per page (10-100)" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            </StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Slider Minimum="10" Maximum="100" StepFrequency="5" TickFrequency="10" TickPlacement="Outside" Value="{Binding StoryLimit, Mode=TwoWay}" />
                                <TextBlock Grid.Column="1" Text="{Binding StoryLimit, Mode=OneWay}" Style="{StaticResource BodyStrongTextBlockStyle}" VerticalAlignment="Center" Margin="16,0,0,0" MinWidth="40" />
                            </Grid>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- About -->
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE946;" FontSize="20" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                        <TextBlock Text="About" Style="{StaticResource SubtitleTextBlockStyle}" />
                    </StackPanel>
                    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="20">
                        <StackPanel Spacing="12">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <Border Background="#FF6600" CornerRadius="6" Padding="12,10">
                                    <TextBlock Text="HN" FontWeight="Bold" FontSize="16" Foreground="White" />
                                </Border>
                                <StackPanel VerticalAlignment="Center" Spacing="2">
                                    <TextBlock Text="HN Reader" Style="{StaticResource BodyStrongTextBlockStyle}" FontSize="16" />
                                    <TextBlock Text="Version 1.0.0" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                </StackPanel>
                            </StackPanel>
                            <TextBlock Text="A modern Hacker News reader for Windows, powered by GitHub Copilot SDK for AI-generated insights and personalized news digests." 
                                       Style="{StaticResource CaptionTextBlockStyle}" 
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                                       TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
