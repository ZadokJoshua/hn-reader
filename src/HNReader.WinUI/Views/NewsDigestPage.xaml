<?xml version="1.0" encoding="utf-8" ?>
<Page 
    x:Class="HNReader.WinUI.Views.NewsDigestPage" 
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" 
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" 
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:HNReader.WinUI.Views" 
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
    xmlns:models="using:HNReader.Core.Models"
    xmlns:converters="using:HNReader.WinUI.Converters"
    xmlns:toolkit="using:CommunityToolkit.WinUI.UI.Controls"
    mc:Ignorable="d">
    
    <Page.Resources>
        <!-- Converters -->
        <converters:StringToUriConverter x:Key="StringToUriConverter" />
        
        <!-- Segmented Control RadioButton Style -->
        <Style x:Key="SegmentedRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{ThemeResource TextFillColorPrimaryBrush}" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Padding" Value="16,8" />
            <Setter Property="Margin" Value="2" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="MinHeight" Value="32" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="RootBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="0"
                                CornerRadius="{TemplateBinding CornerRadius}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter x:Name="ContentPresenter"
                                            Content="{TemplateBinding Content}"
                                            ContentTemplate="{TemplateBinding ContentTemplate}"
                                            HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                            VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                            AutomationProperties.AccessibilityView="Raw" />
                            
                                                        <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CombinedStates">
                                    <!-- Unchecked states -->
                                    <VisualState x:Name="Normal" />
                                    <VisualState x:Name="PointerOver">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource SubtleFillColorSecondaryBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Pressed">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource SubtleFillColorTertiaryBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Disabled">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootBorder" Storyboard.TargetProperty="Opacity">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="0.5" />
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <!-- Checked states - maintain selected background on hover/press -->
                                    <VisualState x:Name="Checked">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentFillColorDefaultBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource TextOnAccentFillColorPrimaryBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="CheckedPointerOver">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentFillColorSecondaryBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource TextOnAccentFillColorPrimaryBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="CheckedPressed">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentFillColorTertiaryBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource TextOnAccentFillColorSecondaryBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="CheckedDisabled">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentFillColorDisabledBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource TextOnAccentFillColorDisabledBrush}" />
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>
    
    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <StackPanel Grid.Row="0" Spacing="8" Margin="0,0,0,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <Border Background="#FF6600" CornerRadius="8" Padding="12,8">
                        <FontIcon Glyph="&#xE9D9;" FontSize="24" Foreground="White" />
                    </Border>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="News Digest" Style="{StaticResource TitleTextBlockStyle}" FontWeight="Bold" />
                        <TextBlock Text="{Binding DigestDate}" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                    </StackPanel>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <Button Command="{Binding GenerateDigestCommand}" 
                            IsEnabled="{Binding HasInterests}"
                            Visibility="{Binding IsGenerating, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon Glyph="&#xE768;" FontSize="14" />
                            <TextBlock Text="Generate Digest" />
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding GenerateDigestCancelCommand}" 
                            Visibility="{Binding IsGenerating, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon Glyph="&#xE711;" FontSize="14" />
                            <TextBlock Text="Cancel" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </StackPanel>
        
        <!-- Interests Preview Card -->
        <Border Grid.Row="1" 
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                BorderThickness="1" 
                CornerRadius="8" 
                Padding="16" 
                Margin="0,0,0,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Spacing="4">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE8F1;" FontSize="16" Foreground="#FF6600" />
                        <TextBlock Text="Your Interests" FontWeight="SemiBold" />
                    </StackPanel>
                    <TextBlock Text="{Binding InterestsPreview}" 
                               Style="{StaticResource CaptionTextBlockStyle}"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                               TextWrapping="Wrap" />
                </StackPanel>
                
                <Button Grid.Column="1" 
                        x:Name="ManageInterestsButton"
                        Click="ManageInterestsButton_Click"
                        VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE70F;" FontSize="14" />
                        <TextBlock Text="Manage" />
                    </StackPanel>
                </Button>
            </Grid>
        </Border>
        
        <!-- Loading Overlay -->
        <Border Grid.Row="2" 
                Visibility="{Binding IsGenerating, Converter={StaticResource BoolToVisibilityConverter}}"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                BorderThickness="1" 
                CornerRadius="8" 
                Padding="24" 
                Margin="0,0,0,16">
            <StackPanel HorizontalAlignment="Stretch" Spacing="12">
                <ProgressBar Minimum="0" Maximum="100" Value="{Binding LoadingProgress}" />
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <ProgressRing IsActive="True" Width="16" Height="16" />
                    <TextBlock Text="{Binding LoadingMessage}" 
                               FontWeight="SemiBold" 
                               TextWrapping="Wrap"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Error Banner -->
        <InfoBar Grid.Row="2"
             IsOpen="{Binding HasError}"
             Severity="Error"
             Title="Generation Failed"
             Message="{Binding ErrorMessage}"
             Margin="0,0,0,16"
             IsClosable="True"
             Closed="ErrorInfoBar_Closed" />
        
        <!-- Summary Card -->
        <Border Grid.Row="3" 
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                BorderThickness="1" 
                CornerRadius="8" 
                Padding="16" 
                Margin="0,0,0,16"
                Visibility="{Binding HasDigest, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel Spacing="8">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE946;" FontSize="16" Foreground="#FF6600" />
                    <TextBlock Text="Digest's Summary" FontWeight="SemiBold" />
                </StackPanel>
                <TextBlock Text="{Binding SummaryText}" TextWrapping="Wrap" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
            </StackPanel>
        </Border>
        
        <!-- Segmented Control for Digest Groups -->
        <Border Grid.Row="4"
                x:Name="SegmentedControlContainer"
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="4"
                HorizontalAlignment="Center"
                Visibility="{Binding HasDigest, Converter={StaticResource BoolToVisibilityConverter}}"
                Margin="0,12,0,16">
            <StackPanel x:Name="SegmentedControlPanel" Orientation="Horizontal" />
        </Border>
        
        <!-- Digest Content Area -->
        <Grid Grid.Row="5" Visibility="{Binding HasDigest, Converter={StaticResource BoolToVisibilityConverter}}">
            <!-- Overview Panel: summary cards for each interest group -->
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          Visibility="{Binding IsOverviewSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                <ItemsControl ItemsSource="{Binding DigestGroups}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="models:DigestInterestGroup">
                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                                    BorderThickness="1" 
                                    CornerRadius="8" 
                                    Padding="16" 
                                    Margin="0,0,0,12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Row="0" Text="{x:Bind Interest.Name}" FontWeight="Bold" FontSize="16" />
                                    <TextBlock Grid.Row="1" Text="{x:Bind Summary}" 
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                                               TextWrapping="Wrap"
                                               Margin="0,4,0,0" />
                                    <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="16" Margin="0,8,0,0">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <FontIcon Glyph="&#xE8F4;" FontSize="12" Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                                            <TextBlock FontSize="12" Foreground="{ThemeResource TextFillColorTertiaryBrush}">
                                                <Run Text="{x:Bind StoryCount}" /><Run Text=" stories" />
                                            </TextBlock>
                                        </StackPanel>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- Stories Panel: stories for the selected interest group -->
            <ListView ItemsSource="{Binding SelectedGroupStories}" 
                      SelectionMode="None"
                      Visibility="{Binding IsOverviewSelected, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:HNHit">
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                                BorderThickness="1" 
                                CornerRadius="8" 
                                Padding="16" 
                                Margin="0,0,0,8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <!-- Story content -->
                                <Grid Grid.Column="0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Row="0" Text="{x:Bind Title}" FontWeight="SemiBold" FontSize="15" TextWrapping="Wrap" />
                                    <toolkit:MarkdownTextBlock Grid.Row="1" 
                                               Text="{x:Bind Summary}" 
                                               TextWrapping="Wrap" 
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                               Margin="0,8,0,0"
                                               FontSize="13"
                                               Background="Transparent"
                                               CodeBackground="{ThemeResource LayerFillColorDefaultBrush}"
                                               CodeBorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                                               CodeForeground="{ThemeResource TextFillColorPrimaryBrush}"
                                               InlineCodeBackground="{ThemeResource LayerFillColorDefaultBrush}"
                                               InlineCodeBorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                                               LinkForeground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                               Visibility="{x:Bind Summary, Converter={StaticResource BoolToVisibilityConverter}}" />
                                    <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="12" Margin="0,6,0,0">
                                        <TextBlock FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                            <Run Text="by " /><Run Text="{x:Bind Author}" FontWeight="SemiBold" />
                                        </TextBlock>
                                        <TextBlock FontSize="12" Foreground="{ThemeResource TextFillColorTertiaryBrush}">
                                            <Run Text="â€¢ " /><Run Text="{x:Bind CreatedAt, Converter={StaticResource RelativeTimeConverter}}" />
                                        </TextBlock>
                                    </StackPanel>
                                    <StackPanel Grid.Row="3" Orientation="Horizontal" Spacing="16" Margin="0,8,0,0">
                                        <HyperlinkButton NavigateUri="{x:Bind Url, Converter={StaticResource StringToUriConverter}}" Padding="0" VerticalAlignment="Center">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <FontIcon Glyph="&#xE8A7;" FontSize="12" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                                                <TextBlock Text="View Source" FontSize="12" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                                            </StackPanel>
                                        </HyperlinkButton>
                                    </StackPanel>
                                </Grid>

                                <!-- Thumbnail image (left side, collapsed when no image) -->
                                <Border Grid.Column="1" 
        Width="170" Height="170" 
        CornerRadius="6" 
        Margin="0,0,14,0"
        Visibility="{x:Bind HasImage, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <Border.Background>
                                        <ImageBrush ImageSource="{x:Bind ImageUri, Converter={StaticResource UriToImageSourceConverter}}" Stretch="UniformToFill" />
                                    </Border.Background>
                                </Border>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <!-- Empty State (no digest, not generating) -->
        <StackPanel Grid.Row="5" 
                    HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="12"
                    Visibility="{Binding HasDigest, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
            <FontIcon Glyph="&#xE9D9;" FontSize="48" Foreground="{ThemeResource TextFillColorTertiaryBrush}" HorizontalAlignment="Center" />
            <TextBlock Text="No digest yet" 
                       Style="{StaticResource SubtitleTextBlockStyle}" 
                       Foreground="{ThemeResource TextFillColorTertiaryBrush}" 
                       HorizontalAlignment="Center" />
            <TextBlock Text="Click 'Generate Digest' to create your personalized news digest" 
                       Style="{StaticResource CaptionTextBlockStyle}" 
                       Foreground="{ThemeResource TextFillColorTertiaryBrush}" 
                       HorizontalAlignment="Center" />
        </StackPanel>
    </Grid>
</Page>
